# 上传文件

## 以 form-data 的形式上传

1. 把文件作为表单数据的一部分上传，发送的是文件，表单的数据之间以标签为单元，用 ```boundary``` 分隔符分开
2. ```Content-Type: multipart/form-data```
3. 把文件存储到本地：
    ```java
    @PostMapping(value = "/file/upload")
    public String upload(@RequestPart("file") MultipartFile file) {
        String fileName = file.getOriginalFilename();
        String filePath = "/a/b/" + fileName;
        File realFile = new File(filePath);
        realFile.getParentFile().mkdirs();
        file.transferTo(realFile);
    }
    ```
4. 服务之间调用文件上传接口
    ```java
    @Test
    void uploadFile() throws Exception {
        String fullFileName = "/x/y/z.log";
        String url = "http://localhost:8080/file/upload";
        uploadFormData(fullFileName, url);
    }

    public ResponseEntity uploadFormData(String fullFileName, String url) throws Exception {
        HttpHeaders headers = new HttpHeaders();
        headers.setAccept(Arrays.asList(MediaType.APPLICATION_JSON));
        headers.setContentType(MediaType.MULTIPART_FORM_DATA);
        MultiValueMap<String, Object> param = new LinkedMultiValueMap<>();
        FileSystemResource resource = new FileSystemResource(fullFileName);
        param.add("file", resource);
        HttpEntity<MultiValueMap<String, Object>> formEntity = new HttpEntity<>(param, headers);
        ResponseEntity<String> responseEntity = restTemplate1.postForEntity(url, formEntity, String.class);
        return responseEntity;
    }
    ```
5. 取文件长度：
    ```java
    file.getSize();
    ```

## 以 binary 的形式上传

1. 把文件作为二进制数据上传，发送的是字节数组
2. ```Content-Type: application/octet-stream```
3. 把文件存储到本地：
    ```java
    @PutMapping(value = "/file/upload")
    public String upload(HttpServletRequest request, @RequestParam(required = true) String fileName) {
        String filePath = "/a/b/" + fileName;
        File realFile = new File(filePath);
        realFile.getParentFile().mkdirs();
        Path path = Paths.get(filePath);
        FileCopyUtils.copy(request.getInputStream(), Files.newOutputStream(path));
    }
    ```
4. 服务之间调用文件上传接口
    ```java
    @Test
    void uploadFile() throws Exception {
        String fullFileName = "/x/y/z.log";
        String url = "http://localhost:8080/file/upload?fileName=z.log";
        uploadBinary(fullFileName, url);
    }

    public ResponseEntity uploadBinary(String fullFileName, String url) throws Exception {
        HttpHeaders headers = new HttpHeaders();
        headers.setAccept(Arrays.asList(MediaType.APPLICATION_JSON));
        headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);
        File file = new File(fullFileName);
        FileInputStream inputStream = new FileInputStream(file);
        byte[] buffer = IOUtils.toByteArray(inputStream);
        inputStream.close();
        HttpEntity<byte[]> requestEntity = new HttpEntity<>(buffer, headers);
        ResponseEntity<String> responseEntity = restTemplate1.exchange(url, HttpMethod.PUT, requestEntity, String.class);
        return responseEntity;
    }
    ```
5. 取文件长度：
    ```java
    inputStream.available();
    ```

## FAQ

### 413 Request Entity Too Large

1. Nginx服务器配置
    在 **http{ }** 中配置：client_max_body_size 100M
    ```bas
    # vim ./conf/nginx.conf
    client_max_body_size 100M;
    
    # ./sbin/nginx -s reload
    ```

2. 网关配置
    ```
    spring.servlet.multipart.max-file-size=50MB
    spring.servlet.multipart.max-request-size=100MB
    ```

3. 文件上传/下载的业务模块配置
    ```
    spring.servlet.multipart.max-file-size=50MB
    spring.servlet.multipart.max-request-size=100MB
    ```

4. 文件确实过大
   - 压缩文件
   - 拆分文件
   - 调整上述配置
