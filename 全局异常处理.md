# 全局异常处理

## Controller 层

### 注解

- ```@ControllerAdvice```: 捕获 Controller 层抛出的异常，如果添加 @ResponseBody 返回信息则为 JSON 格式
- ```@RestControllerAdvice```: 相当于 @ControllerAdvice 与 @ResponseBody 的结合体
- ```@ExceptionHandler```: 统一处理一种类的异常，减少代码重复率，降低复杂度

### 示例

添加依赖:

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-log4j2</artifactId>
</dependency>

<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
</dependency>
```

```java
@RestControllerAdvice
@Slf4j
public class ExceptionHandlerAdvice {
    @ExceptionHandler(Exception.class)
    public ResponseResult<Void> exceptionHandler(Exception e) {
        log.error(e.getMessage(), e);
        return ResponseResultUtil.error(-1, e.getMessage());
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseResult<Void> methodArgumentNotValidExceptionHandler(MethodArgumentNotValidException e) {
        BindingResult bindingResult = e.getBindingResult();
        List<FieldError> fieldErrorList = bindingResult.getFieldErrors();
        StringBuilder builder = new StringBuilder();
        fieldErrorList.forEach(x -> builder.append(x.getDefaultMessage() + ";"));
        log.error(e.getMessage(), e);
        return ResponseResultUtil.error(-1, builder.toString());
    }


    @ExceptionHandler(ValidationException.class)
    public ResponseResult<Void> validationExceptionHandler(ValidationException e) {
        log.error(e.getMessage(), e);
        return ResponseResultUtil.error(-1, e.getMessage());
    }

    @ExceptionHandler
    public ResponseResult<Void> handle(ConstraintViolationException e) {
        Set<ConstraintViolation<?>> violations = e.getConstraintViolations();
        StringBuilder builder = new StringBuilder();
        violations.forEach(x -> builder.append(x.getMessage() + ";"));
        log.error(e.getMessage(), e);
        return ResponseResultUtil.error(-1, builder.toString());
    }

}

```

## 非 Controller 层

非 Controller 层包括：没有被 Controller 调用的 Service 层、异步方法等。
