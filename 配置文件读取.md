# 配置文件读取

## 线程安全的单例模式读取多环境配置文件

```java
import lombok.extern.slf4j.Slf4j;
import org.yaml.snakeyaml.Yaml;

import java.io.InputStream;
import java.util.Map;

@Slf4j
public enum PureYaml {
    INSTANCE;
    private Map<String, Object> config;

    PureYaml() {
        try {
            Yaml yaml = new Yaml();

            // 1. 读取主配置文件
            try (InputStream inputStream = PureYaml.class
                    .getClassLoader()
                    .getResourceAsStream("application.yml")) {
                if (inputStream != null) {
                    config = yaml.load(inputStream);
                }
            }

            // 2. 读取环境特定配置
            String activeProfile = getActiveProfile();
            if (activeProfile != null && !activeProfile.isEmpty()) {
                try (InputStream profileStream = PureYaml.class
                        .getClassLoader()
                        .getResourceAsStream("application-" + activeProfile + ".yml")) {
                    if (profileStream != null) {
                        Map<String, Object> profileConfig = yaml.load(profileStream);
                        mergeConfig(config, profileConfig);
                    }
                }
            }
        } catch (Exception e) {
            throw new RuntimeException("Failed to load YAML configuration", e);
        }
    }

    private String getActiveProfile() {
        // 1. 尝试从系统属性读取
        String profile = System.getProperty("spring.profiles.active");
        if (profile != null) return profile;

        // 2. 尝试从环境变量读取
        profile = System.getenv("SPRING_PROFILES_ACTIVE");
        if (profile != null) return profile;

        // 3. 从主配置文件读取
        try {
            Yaml yaml = new Yaml();
            try (InputStream inputStream = PureYaml.class
                    .getClassLoader()
                    .getResourceAsStream("application.yml")) {
                if (inputStream != null) {
                    Map<String, Object> mainConfig = yaml.load(inputStream);
                    Map<String, Object> springConfig = getMapValue(mainConfig, "spring");
                    if (springConfig != null) {
                        Map<String, Object> profiles = getMapValue(springConfig, "profiles");
                        if (profiles != null) {
                            return (String) profiles.get("active");
                        }
                    }
                }
            }
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
        return "";
    }

    @SuppressWarnings("unchecked")
    private Map<String, Object> getMapValue(Map<String, Object> map, String key) {
        if (map == null) return null;
        Object value = map.get(key);
        return value instanceof Map ? (Map<String, Object>) value : null;
    }

    @SuppressWarnings("unchecked")
    private void mergeConfig(Map<String, Object> base, Map<String, Object> overlay) {
        if (base == null || overlay == null) return;

        for (Map.Entry<String, Object> entry : overlay.entrySet()) {
            String key = entry.getKey();
            Object value = entry.getValue();

            if (base.containsKey(key) && base.get(key) instanceof Map &&
                    value instanceof Map) {
                // 递归合并嵌套的Map
                mergeConfig((Map<String, Object>) base.get(key),
                        (Map<String, Object>) value);
            } else {
                // 覆盖或新增
                base.put(key, value);
            }
        }
    }

    @SuppressWarnings("unchecked")
    public Object getProperty(String key) {
        if (config == null) return null;

        String[] keys = key.split("\\.");
        Map<String, Object> current = config;

        for (int i = 0; i < keys.length - 1; i++) {
            Object value = current.get(keys[i]);
            if (value instanceof Map) {
                current = (Map<String, Object>) value;
            } else {
                return null;
            }
        }

        return current.get(keys[keys.length - 1]);
    }

    public String getStringProperty(String key) {
        Object value = getProperty(key);
        return value != null ? value.toString() : null;
    }

    public String getStringProperty(String key, String defaultValue) {
        String value = getStringProperty(key);
        return value != null ? value : defaultValue;
    }
}
```

调用方式：

```java
PureYaml.INSTANCE.getStringProperty("key.key1");
```
